, 57.087.
Автоматизированная обработка и анализ медицинских изображений являются мощным инструментом медицинской диагностики.
Современные системы автоматической микроскопии активно используются для предварительной классификации клеток крови с дальнейшим контролем результатов врачом.
Классификация клеток крови на микроскопическом изображении представляет собой, в терминах компьютерного зрения, задачу распознавания объектов.
Стандартный подход к решению этой задачи предусматривает два этапа [1]: разделение  изображения на области, соответствующие объектам и фону; непосредственно распознавание объектов, включающее в себя выделение характерных признаков объектов и распределение объектов в соответствии с их признаками по классам.
Примерно за пять десятилетий развития компьютерного зрения как науки предложено множество методов сегментации изображений, формирования векторов признаков объектов и их классификации.
Такое разнообразие ставит перед исследователем непростую проблему выбора методов, наиболее адекватных специфике конкретной задачи.
Специфика задачи более всего сказывается на формировании векторов признаков объектов, в значительной степени на выборе метода сегментации и существенно меньше на выборе классификатора.
Таким образом, при выборе стратегии решения данной задачи большое внимание авторами было уделено изучению опыта применения различных методов сегментации микроскопических изображений и характерным признакам, используемым для классификации клеток крови.
В соответствии с основными этапами решения задачи первые разделы статьи посвящены используемому методу сегментации изображений клеток крови, следующие признакам клеток крови, используемым для их классификации.
Заключительная часть посвящена собственно процедуре  классификации, результатам тестирования и разработанному программному обеспечению.
Качество сегментации ключевой фактор для получения адекватных значений характерных признаков объекта, а значит, для его верной классификации.
Так, в работе [2] отмечено, что более половины ошибок классификации лейкоцитов были обусловлены неправильной сегментацией.
Основные причины, ведущие к ошибкам сегментации микроскопических изображений: перекрывание одной клетки другой, сильная вариация клеток по форме и размеру, воздействие разных факторов на внешний вид клетки, слабая контрастность изображений с дополнительными проблемами, вызываемыми шумами.
Еще один усложняющий фактор вариабельность окраски препаратов крови: часто после окраски контрастность контуров структурных элементов внутри клетки превышает контрастность границ самой клетки.
Из трех основных видов клеток крови  самую большую сложность для сегментации представляют последние.
Лейкоциты не являются однородными: их ядра состоят из одного или нескольких сегментов  и цитоплазмы.
Иногда ядра плохо различимы .
Цитоплазма часто бывает неоднородной, гранулированной, что затрудняет сегментацию.
Исследования компьютерной сегментации микроскопических изображений мазков крови начались в 70-е годы прошлого века и продолжаются до сих пор.
Из энергетических методов широко используется для сегментации изображений клеток крови семейство алгоритмов активного контура .
Основная их идея состоит в минимизации энергии кривой, представляющей границу сегмента.
Существенная проблема с данными алгоритмами заключается в том, что топология сегмента должна быть известна заранее.
На практике определенные такими методами границы клеток крови часто значительно отличаются от истинных границ, в то время как формы границ весьма важны для правильной классификации клеток.
К тому же эти методы не способны выделять области внутреннего просветления у ряда эритроцитов .
Методы пороговой сегментации имеют разнообразные приложения, в том числе к задачам сегментации микроскопических изображений.
Однако при применении данных методов к задаче сегментации эритроцитов, как и в случае методов активного контура, возникают проблемы при значительных просветлениях внутри изображений эритроцитов.
Методы наращивания областей широко использовались и для решения задачи сегментации изображений клеток крови.
Работа этих алгоритмов начинается с набора точек, которые являются исходными для последующего присоединения новых точек, исходя из некоторого условия гомогенности.
Поскольку цвет клеток и ядер не везде однородный, результатом работы алгоритма может быть переили недосегментация.
Методы кластеризации, например кластеризация на основе схемы K-средних, тоже нашли свое применение в данной области .
Однако, как правило, для таких методов время на вычисление значительно возрастает, если число кластеров больше двух.
Методы для непосредственного определения границ между областями на изображении обычно более точны, но и более сложны в применении.
Подходы к реализации данной процедуры также весьма разнообразны.
Что касается упомянутых подходов, отметим, что некоторые методы, основанные на теории графов, доказали свою эффективность.
К их числу можно отнести адаптивный алгоритм замыкания контуров, представленный в [4].
В качестве исходных данных берется множество граничных точек, полученных некоторым образом.
Производится постепенное расширение граничных точек: добавление соседних точек с изучением новых замыканий.
В работе изучаются два подхода: в первом добавление точек идет во всех направлениях, во втором только в некоторых специальных направлениях.
Второй подход показал себя существенно лучше.
При этом подходе строится скелет граничных точек, находятся концевые точки этого скелета-графа.
В каждой концевой точке по самой точке и по трем ближайшим точкам графа строится направляющий конус с вершиной в данной точке.
Добавление точек проводится в направлении построенных конусов.
При возникновении замыкания конус перестает использоваться.
В заключение упомянем метод сегментации, предложенный Ritter и Cooper в работе [5].
Он является комбинацией автоматического выбора порога и связных компонент с современной адаптацией классического в теории графов алгоритма Dijkstra кратчайшего пути.
Первоначально изображение преобразуется в серое и строится гистограмма яркости.
По этой гистограмме находится порог для определения фона.
Фон изображения затем определяется не просто по порогу, а с использованием алгоритма 4-связности: все связные пиксели с яркостью выше порога заменяются на белые.
Метод оставляет нетронутыми области просветления внутри эритроцитов.
На следующем шаге осуществляется поиск связных компонент.
Затем проводятся утончение, улучшение полученных границ с помощью модификации алгоритма Dijkstra кратчайшего пути.
Метод работает быстро и дает однопиксельные границы клеток или групп клеток.
Недостатком алгоритма является то, что перекрывающиеся клетки не могут быть разделены.
При выборе подхода к сегментации изображений клеток крови основным критерием являлась точность выделяемых границ сегментов, влияющая на адекватность вычисляемых геометрических характеристик полученных сегментов.
Как отмечалось выше, методы, основанные на использовании граничных точек, обычно дают некоторый выигрыш в точности определения границ сегментов, требуя при этом достаточно сложных процедур постобработки.
Это и было использовано авторами при выборе методики сегментации.
Ключевую роль в создании метода сегментации сыграла разрабатываемая в НИИСИ РАН программная система сравнительного исследования алгоритмов обработки изображений PICASSO [6], идеологической основой которой стала методика EDEM.
Необходимость создания данной системы была обусловлена тем, что к настоящему времени оценка качества работы различных компьютерных программ, решающих некоторую конкретную задачу, представляет собой процесс, не имеющий единой методики .
Используемая авторами методика строит оценку качества на основе вычисления некоторой количественной меры различия результата работы программы на некотором наборе тестовых изображений, для которых эталонное решение, так называемое ground truth, известно априори.
Такой подход к оценке качества программных продуктов в англоязычной литературе называется discrepancy method, что определило выбор названия методики: EDEM .
Характерной чертой методики является внесение в тестовые изображения контролируемых искажений: размытия, зашумления .
Данная методика совершенствуется в плане выбора и построения тестовых материалов и соответствующих эталонов, а также анализа и сочетания количественных мер различия.
Что касается требований к тестовым изображениям, они должны учитывать специфику задачи, которую призваны решать сравниваемые между собой программы .
Следующее требование полнота отображения в конечном наборе изображений ситуаций, возникающих при решении конкретной практической задачи.
Данное требование плохо формализуется, и поэтому доказательство полноты, как правило, невозможно.
В этом случае ограничиваются экспертными оценками полноты тестового материала, требуя при необходимости его пополнения.
Наконец, тестовые изображения должны содержать ситуации, трудные для тестируемых программ.
В качестве примера на рисунке 2a, б представлены одно из использованных тестовых изображений и соответствующий ему ground truth-образ .
Трудность ситуации обусловлена наличием перекрывающихся областей и относительно слабой вариацией контраста вдоль границ сегментации.
Рисунок 2в, г отражает результаты сегментации разработанным методом и  энергетическим методом сегментации ГеманаРейнольдса [6].
В итоге был предложен метод сегментации, являющийся комбинацией детектора граничных точек Canny и упоминавшегося выше метода RitterCooper [5] и использующий на этапе постобработки усовершенствованную процедуру замыкания контуров.
Что касается метода RitterCooper, его недостатком является то, что перекрывающиеся клетки не могут быть разделены.
Между тем в клинической практике перекрывающиеся и слипшиеся на изображении клетки крови неизбежны.
Использование этого метода совместно с детектором Canny, позволяющим находить границы внутри объектов, во многих случаях дает возможность разделить перекрывающиеся или слипшиеся клетки.
На этапе замыкания контуров, в частности, тестировался упоминавшийся выше алгоритм [4].
Этот алгоритм прост в реализации, но при его применении к данной задаче не были получены границы достаточно высокого качества.
Поэтому был разработан метод замыкания контуров, развивающий идеи, предложенные ранее авторами данной статьи для задачи распознавания текстов.
Рассмотрим более подробно последовательные этапы работы описываемого комбинированного метода сегментации.
На первом этапе осуществляется поиск граничных точек.
Чтобы получить из найденных с помощью фильтра Canny потенциальных граничных точек собственно границу сегмента, нужно удалить точки, формирующие ложные границы и границы внутри клеток крови, и точки, примыкающие к истинной границе.
Полученные точки далеко не всегда формируют замкнутые контуры, и требуется замыкание контуров.
Эти действия относятся к процедурам постобработки и выполняются на следующих этапах работы предложенного метода сегментации.
Этапы работы описываемого метода сегментации иллюстрируют рисунки 35.
Так, на рисунке 3 показан пример исходного изображения.
На рисунке 4а показаны потенциальные граничные точки, полученные на первом этапе работы метода сегментации.
Требуется их дальнейшая обработка для получения замкнутых компонент границ и удаления ложных границ и помех.
На втором этапе производятся склейка разрывов в границах, удаление помех.
Все полученные на первом этапе граничные точки представляются в виде графов .
Находятся все особые точки графов.
Затем изучаются особые точки индекса 1, то есть концевые вершины графа .
Для каждой особой точки индекса 1 определяется направление, в котором будет проводиться поиск возможного замыкания.
Направление вычисляется исходя из длины и кривизны хвоста.
Как и в работе [4], в соответствии с полученным направлением строится направляющий конус, внутри которого ищется ближайшая точка графа.
Дополнительно идет поиск ближайшего хвоста, что позволяет соединять концевые точки отклоняющихся направлений.
При выполнении необходимых условий найденные точки соединяются.
Если для концевой точки нет приемлемого варианта соединения с иной граничной точкой, эта концевая точка и вся ветка графа с окончанием в этой точке удаляются.
На рисунке 4б показаны граничные точки, обработанные на втором этапе работы метода.
Очевидно, что эритроциты достаточно хорошо сегментируются уже на этом этапе, а пересегментация  связана в основном с просветлениями в центрах эритроцитов.
На третьем этапе выделяются предварительные сегменты области изображения, ограниченные найденными контурами.
Проводится анализ сегментов: определяются параметры формы, цвета, текстуры.
На основании этого сравнительно несложного анализа делается предварительный вывод о принадлежности сегмента к ядру, цитоплазме или фону.
Например, темный фиолетовый цвет сегмента наиболее вероятно указывает на его принадлежность к ядру некоторого лейкоцита .
На четвертом этапе полученные сегменты по возможности укрупняются, особенно это касается неоднородных сегментов цитоплазмы.
Процедура объединения сегментов происходит итерационно.
На каждой итерации расставляются метки сегментов: ядро, цитоплазма, тромбоцит.
Затем попарно проверяются все соседние сегменты.
Вначале рассматриваются сегменты ядра.
Те из них, которые граничат друг с другом, объединяются.
Далее происходит объединение сегментов цитоплазмы .
Затем рассматриваются прочие сегменты на предмет их объединения.
После этого происходит следующая итерация с теми же действиями.
На каждой итерации метки сегментов могут изменяться.
При объединении сегментов характеристики объединенного сегмента пересчитываются.
На рисунке 5a отображены результаты предварительной сегментации.
Сегменты закрашены средними цветами .
На рисунке 5б, в показаны результаты первой и второй итераций процедуры объединения сегментов.
Сегменты здесь тоже закрашены средними цветами.
На заключительном, пятом, этапе происходит объединение ядер и цитоплазм лейкоцитов в целые клетки .
На этом же этапе удаляются ложные объекты .
На рисунке 5г показаны уже обработанные, укрупненные сегменты результат итоговой итерации.
Тесты, проведенные на более чем 4 000 реальных изображений, содержащих лейкоциты, эритроциты и тромбоциты, показали, что данный комбинированный метод обеспечивает корректную сегментацию клеток крови в 98 % случаев.
Хороших результатов работы метода удалось добиться на слипшихся клетках, относящихся к разным типам.
Во многом это обусловлено тем, что исследование аномалий различных разновидностей лейкоцитов занимает существенное место в диагностике разных заболеваний.
Задаче распознавания эритроцитов посвящено меньше работ, и в разных источниках используются различные классификации эритроцитов .
Что касается тромбоцитов, то они имеют наименьший размер среди основных групп клеток крови, что является ключевым признаком в их распознавании.
Формально для сортировки лейкоцитов в  используется тот же перечень признаков клеток, который доступен врачу при ручной микроскопии окрашенного мазка: характеристики морфологии и цвета отдельных клеток, характеристики морфологии и цвета выборки клеток в целом.
Однако фактически САМ и врач используют разные наборы признаков, поскольку описанные в учебниках качественные признаки морфологии и цвета плохо поддаются формализации.
Признаки, по которым классифицируются лейкоциты в САМ, можно разделить на три группы: цветояркостные, текстурные и геометрические.
К цветояркостным характеристикам, измеряемым в САМ, относятся цвета и оптические плотности цитоплазмы клеток.
Как показывает практика, дискриминирующие свойства цветояркостных характеристик цитоплазмы довольно высоки, но, к сожалению, только в пределах одного препарата.
Так, например, характерные цвета цитоплазмы эозинофилов в одном препарате вполне могут соответствовать цветам нейтрофилов в другом.
Как правило, в САМ, использующих цветояркостные признаки, применяются различные способы нормировки цветов.
Основная проблема при использовании текстурных характеристик заключается в том, что любая характеристика текстуры зависит от разрешения оптической и оцифровывающей систем.
При использовании разных объективов, оптических адаптеров и телекамер измеренные характеристики текстуры могут изменяться в несколько раз.
Поэтому для получения устойчивой характеристики текстуры необходимо либо снимать изображения на однажды зафиксированном типе оборудования, либо вводить поправку измеренной характеристики на разрешение .
Геометрические признаки принято относить к более широкому классу морфометрических признаков, выражающих общие размеры и форму клетки и ядра.
Для вычисления данных признаков требуются лишь маска рассматриваемого объекта и его граница: нет необходимости рассматривать его исходное изображение .
Как показывает диагностическая практика, ранние стадии заболеваний оказывают чаще всего незначительное влияние на форму клетки и ядра, зато в задаче сортировки клеток геометрические признаки играют значительную роль.
На сегодня имеется сравнительно немного доступной информации о типичных ошибках систем сортировки лейкоцитов, основанных на описанных выше трех группах признаков.
Ошибки данных систем принято разделять на ошибки сегментации изображения и ошибки собственно классификации .
Что касается компьютерных систем сортировки эритроцитов, то отсутствие их канонической классификации приводит к созданию систем с различными наборами выходных классов .
На практике встречается разделение эритроцитов всего на два выходных класса: нормальные клетки и больные клетки [8, 9].
При этом под нормальными понимаются эритроциты, имеющие форму двояковыгнутых безъядерных дисков диаметром 48 микрон .
Эритроциты, не удовлетворяющие указанным признакам, объявляются больными.
Как и в случае лейкоцитов, признаки классификации эритроцитов делятся на геометрические, цветояркостные и текстурные.
К геометрическим признакам примыкают и Фурье-дескрипторы контура клетки, к цветояркостным гистограммы яркости изображений.
Следует отметить, что вопрос об оптимальном наборе признаков классификации эритроцитов остается открытым.
Имеются работы, дающие сопоставимое качество классификации при различном числе используемых признаков.
Наконец, определенную трудность для распознающих систем создают слипшиеся эритроциты.
Во многих работах по анализу клеток крови используется техника растаскивания слипшихся клеток при помощи применения морфологических фильтров.
Затем разделенные клетки восстанавливаются.
Заметим, что если такая методика и оправдывает себя в задаче подсчета эритроцитов, то в задаче распознавания больных лейкоцитов она представляется сомнительной, поскольку при деформациях теряются важные для распознавания признаки клеток.
Часть признаков используется на этапе сегментации для определения того, относится ли рассматриваемый сегмент к ядру или цитоплазме лейкоцита, эритроциту, тромбоциту или ложному объекту.
Наборы признаков для лейкоцитов и безъядерных клеток  существенно пересекаются.
Для классификации лейкоцитов использовались следующие признаки.
1.
Минимальный и максимальный размеры сегмента.
Вычисляются в соответствии с заданным разрешением пиксел/мкм.
2.
Относительная величина сегмента.
Площадь сегмента относительно средней площади эритроцита.
Признак полезен в случае, когда разрешение неизвестно.
3.
Относительная величина ядер.
Сумма площадей всех ядер относительно средней площади эритроцита.
Признак полезен в случае, когда разрешение неизвестно.
4.
Заполненность ядра.
Отношение площади ядра к площади описанного прямоугольника.
5.
6.
Коэффициент формы ядра.
Отражает отношение площади максимального ядра к квадрату числа граничных точек .
7.
Оттенок.
Три признака: средние значения красной, синей и зеленой составляющих оттенка цвета цитоплазмы.
Оттенок существенно более устойчивый признак, чем цвет при изменении условий съемки.
8.
Цвет.
Три признака: средние значения красной, синей и зеленой составляющих цвета цитоплазмы.
Эти признаки неустойчивы при анализе изображений, сделанных в разных условиях, но полезны при идентификации сегмента на исходном изображении.
9.
Сигма.
Три признака: отражают значения среднеквадратичного отклонения красной, синей и зеленой составляющих оттенка цвета цитоплазмы.
10.
Зерно.
Отражает зернистость цитоплазмы.
11.
Количество ядер в сегменте.
12.
Отношение суммарной площади ядер к площади всего сегмента.
13.
Площадь максимального ядра относительно суммарной площади ядер в сегменте.
14.
Расстояние от взвешенного центра ядер до центра сегмента.
15.
Перемычка, Вторая перемычка.
Для каждой точки границы максимального ядра находится расстояние до противоположной точки границы .
Затем для построенной функции находятся максимальный прогиб и второй по величине прогиб.
16.
Перемычка 3.
Рассчитывается аналогично признаку Перемычка, но в качестве противоположной точки для данной используется ближайшая точка границы, обнаруженная при движении от данной точки в направлении, перпендикулярном границе.
17.
Подкова.
Определяется, похоже ли максимальное ядро по форме на подкову.
В случае сходства вычисляется отношение толщины в центре подковы к толщине по краям.
Для классификации эритроцитов и тромбоцитов авторы использовали те же признаки, что и для лейкоцитов, за исключением признаков 3, 6, 914 .
Признак 5 здесь момент границы всей клетки.
Кроме того, использовались следующие признаки.
Фактор формы.
Отражает отношение площади сегмента к квадрату числа граничных точек .
Перепад цвета.
Отражает среднее значение перепада яркости  вдоль горизонтальных и вертикальных линий.
Второй перепад цвета.
Отражает среднее значение второго по величине прогиба на графике яркости вдоль горизонтальных и вертикальных линий.
Площадь внутренней области.
Площадь области просветления в центре сегмента относительно площади всего сегмента.
Вторая площадь внутренней области.
Отражает площадь второй области просветления в центре сегмента.
Внутренний момент.
Момент границы внутренней области просветления.
На выбор классификатора специфика задачи влияет гораздо меньше, чем на выбор метода сегментации и на формирование признакового пространства.
Поэтому на этапе непосредственной классификации клеток крови используются в основном стандартные методы и подходы.
В CAM наиболее популярными классификаторами являются нейронные сети [2, 7].
При этом современные САМ, использующие данные классификаторы, показывают высокую степень согласованности с результатами ручной микроскопии.
Так, для систем, описанных в [2, 7], по результатам испытаний эта цифра превышает 90 %.
Для решения задачи классификации клеток крови по вектору признаков авторы использовали нейронную сеть типа многослойный персептрон.
Нейроны сети могут быть связаны между собой различным образом.
В данном случае была реализована нейронная сеть с полной системой последовательных связей, то есть выход нейрона данного слоя соединен со входами всех нейронов только последующего слоя.
Сеть такой конфигурации обладает важным свойством: ее поведение устойчиво в отличие, например, от сети с рекуррентными связями .
Полезной особенностью данной функции является так называемый автоматический контроль усиления, то есть при больших отрицательных и больших положительных значениях производная близка к нулю, а при малых значениях она максимальна.
Таким образом, обеспечивается нормальное функционирование сети при слабых и при сильных входных сигналах.
На рисунке 6 представлено главное окно программы-оболочки с загруженным исходным изображением  и результатом классификации обнаруженных на этом изображении клеток .
Предварительное разделение обнаруженных сегментов на потенциальные лейкоциты и безъядерные клетки осуществлялось на этапе сегментации, поэтому признаки каждого сегмента предъявлялись для классификации только на вход своей нейросети.
После анализа  исходных данных для обучения нейросетевых классификаторов было отобрано 7 895 образцов клеток крови .
Обучение проводилось с разными начальными значениями весовых коэффициентов.
С целью уменьшения эффекта от переобучения осуществлялся поиск минимальной конфигурации сети, обеспечивающей отсутствие  ошибок обучения.
Количество нейронов скрытого слоя варьировалось от 150 до 300.
С целью оптимизации признакового пространства и уменьшения эффекта проклятия размерности  минимизировалось количество используемых признаков и, следовательно, количество нейронов входного слоя.
В результате проведенных экспериментов оптимальная конфигурация трехслойной сети, ориентированной на классификацию лейкоцитов, была определена как 172007, а сети, предназначенной для классификации эритроцитов и тромбоцитов, как 142007.
Для того чтобы уверенно говорить о такой эффективности, необходимы дальнейшие исследования, включающие контрольные тесты с использованием данных, не входящих в обучающие последовательности.
Проведена грубая оценка эффективности обсуждаемой методики, включающая в контрольный тест по 100 образцов клеток каждого класса, не использованных в процессе обучения .
Для выделенных в таблице курсивом базофилов, эозинофилов и палочкоядерных нейтрофилов пришлось из-за нехватки исходных данных использовать образцы из обучающей последовательности .
Учитывая, что 4 % сегментоядерных нейтрофилов были отнесены к палочкоядерным нейтрофилам, то есть к тому же большому классу нейтрофилов, можно надеяться, что при доведении количества образцов палочкоядерных нейтрофилов в обучающей последовательности до уровня сегментоядерных качество разделения нейтрофилов на подклассы будет увеличиваться и достигнутый уровень в 91 % будет превзойден.
Моноциты, количество которых в обучающей последовательности на порядок меньше сегментоядерных нейтрофилов, правильно классифицированы в 79 % случаев.
Для базофилов, эозинофилов и палочкоядерных нейтрофилов, представленных в тесте образцами, использованными в обучении, реальное качество классификации, видимо, близко к показателю моноцитов, так как присутствие образцов этих четырех классов в обучающей последовательности соизмеримо друг с другом.
Таким образом, результаты обучения и контрольных тестов позволяют утверждать, что рассмотренная в данной статье методика классификации лейкоцитов, эритроцитов и тромбоцитов для достаточно широкого перечня их классов имеет высокий потенциал.
Для его реализации необходимо дообучить используемые нейронные сети, включив в обучающие последовательности дополнительные образцы для всех рассматриваемых классов клеток крови и обеспечив сбалансированное представительство образцов разных классов.
Для точной оценки эффективности предложенной методики для практического применения необходимо провести всестороннее тестирование с применением контрольных последовательностей, состоящих из образцов, не использованных в обучении, и количественно сравнимых с обучающими последовательностями.
