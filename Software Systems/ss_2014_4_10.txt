
С усложнением микросхем повышается вероятность появления ошибок и затрудняется процесс их поиска, усложняется тестовое ПО.
Тестирование проводится в течение всего жизненного цикла электронных изделий: от проектирования микросхем до контроля модулей в ходе их эксплуатации.
Для современных микросхем трудоемкость создания тестового ПО может превышать трудоемкость создания аппаратной части [1].
При этом полная проверка всех состояний практически невозможна в силу ограничения времени и ресурсов, которые могут быть выделены на тестирование.
Полностью избежать ошибок в микросхемах не удается даже ведущим мировым фирмам.
Конечной целью тестирования является получение надежного и работоспособного изделия, удовлетворяющего требованиям, указанным в документации, и разумным ожиданиям пользователя.
Одним из этапов маршрута тестирования являются функциональные тесты.
В статье показано использование этих тестов для проверки прототипа встроенного контроллера Ethernet 1 Гбит/с.
Технология Ethernet, разработанная в 1973 г.в Центре Xerox PARC, постоянно совершенствуется в соответствии с возрастающими запросами.
С середины 1990-х годов Ethernet стал наиболее распространенной технологией для локальных вычислительных сетей.
Согласно International Data Corporation, 2000 год, 85 % всех установленных сетей Ethernet [2].
Высокоскоростные каналы связи, 10 Гбит/с и выше, применяются в основном в центрах обработки данных, сетевых магистралях, крупных корпоративных и кампусных сетях, сетевыми провайдерами и в медицине.
Существует тенденция роста количества продаж и снижения стоимости 10 Гбит/с сетевого оборудования.
В настоящее время ведется работа над микросхемой 1890ВМ8Я, представляющей собой процессор серии Комдив со встроенным системным контроллером и контроллером Ethernet 1 Гбит/с.
Блок встроенного контроллера Ethernet основан на 1890ВГ15Т, его разработчик сделал ряд усовершенствований.
Для подтверждения правильности принятых технических решений было проведено тестирование.
Использовался прототип устройства на основе ПЛИС Altera, представляющий собой PMC-совместимый модуль, подключаемый к шине PCI технологического процессорного модуля.
Тесты представляли собой программы на языке Си или наборы команд оболочки shell ОС.
В качестве основы тестового ПО использовались системные программы драйверы.
Они выполнялись под управлением ОС и создавали наиболее реалистичные условия работы модели сетевого контроллера.
Ранее в НИИСИ РАН была выполнена подобная проверка для нескольких моделей СБИС [3].
Тесты первоначального включения запускаются для проверки на явные ошибки.
Их главная задача подтвердить возможность тестирования под управлением ОС.
Затем проверяется функциональная пригодность правильность выполнения требований о том, как контроллер должен работать.
Если изделие представляет собой модернизацию ранней версии микросхемы, проверяется их программная совместимость.
Обычно для этого повторно запускаются функциональные тесты, разработанные для предшественника.
Проверка совместимости с различным оборудованием и ОС имеет большое практическое значение, так как каждое из них имеет свои особенности работы.
Проверка позволяет выявить ошибки, которые трудно найти теоретическими методами, и обеспечить уверенность в изделии во время его эксплуатации.
Измерение производительности позволяет подтвердить отсутствие внутренних задержек в контроллере, оценить технические характеристики будущего изделия.
Проверка стабильности и надежности подтверждает способность системы работать продолжительное время.
Кроме того, возможно обнаружение ошибок, которые могут проявиться на случайных данных.
При передаче и приеме большого объема информации сетевой контроллер принимает разнообразные состояния, которые должны быть им правильно отработаны.
Завершающим этапом является стресс-тестирование, которое оценивает корректность работы изделия в ситуациях, связанных с чрезмерно интенсивной нагрузкой.
В статье показано использование методики для тестирования прототипа контроллера Ethernet 1 Гбит/с.
Термин подразумевает, что после включения нового оборудования из него не пошел дым.
В НИИСИ РАН все новые изделия проходят входной контроль.
Затем загружается ОС и выполняется простейшая проверка чтение конфигурационных регистров микросхемы, например DeviceID и VendorID.
Если есть доступ к регистрам по системной шине, возможен запуск программных тестов.
Современные микросхемы имеют большое количество функций и режимов работы.
Выбор состава тестов делается заранее на основе планов организации и технической документации.
Для модели контроллера Ethernet 1 Гбит/c была выбрана проверка, ограниченная возможностями, используемыми системными программами драйверами.
Предполагается, что готовые драйверы для микросхемы 1890ВГ15Т под ОСРВ Багет и под ОС Linux будут использованы в дальнейшем.
Тестирование под управлением драйвера максимально приближает работу сетевого контроллера к условиям реальной эксплуатации.
Такой подход снижает затраты на программирование, но затрудняет диагностику ошибок из-за меньшей наглядности работы драйверов по сравнению со специально разработанными тестами.
На первом этапе функциональной проверки модели контроллера Ethernet использовался тест на основе драйвера микросхемы 1890ВГ15T под ОСРВ Багет.
Тест был создан разработчиками драйвера.
Он осуществлял передачу, прием и проверку пакетов данных в режиме внутренней петли  и петли на уровне приемопередатчиков RGMII .
Скорость передачи данных: 10, 100 и 1 000 Мбит/с.
Длина пакетов данных генерировалась случайным образом.
В режиме внутренней петли на скорости 1 Гбит/с данные передаются с наибольшей скоростью, минуя задержки, связанные с приемопередатчиками, что удобно для проверки кратковременного быстродействия устройства.
На практике этот тест позволил локализовать и исправить наибольшее количество ошибок, имеющих временные причины.
Второй этап проверки основан на сетевом взаимодействии с инструментальной ЭВМ под управлением ОС Linux.
Технологическая плата с прототипом контроллера Ethernet устанавливалась на несущий процессорный модуль ЦП06.
Для задания режимов использовался сетевой коммутатор Hewlett-Packard с заранее запрограммированными скоростями.
Схема подключения приведена на рисунке 1.
Для этих целей использовалась ОСРВ Багет.
Набор тестовых данных представлял собой набор файлов, хранимых на IBM-PC-совместимой инструментальной ЭВМ.
Для проверки были задействованы сетевые протоколы FTP и NFS.
Тесты чтения и записи данных были выполнены для всех возможных скоростей и режимов дуплекса.
Также РПЗУ содержит ряд настроек, связанных с приемопередатчиками RGMII и скоростями работы, служебную информацию и контрольные суммы.
В рамках тестирования функциональности была выполнена проверка записи-чтения данных из РПЗУ, сделаны предложения о формате записываемых данных.
НИИСИ РАН имеет диапазон физических адресов, которые могут быть присвоены разработанным в институте сетевым контроллерам.
Корректные физический и IP-адреса позволили проверить работу устройства в условиях подключения к реальной компьютерной сети.
Так как прототип котроллера Ethernet планируется встроить в новый процессор, особый интерес представляет аналог будущего процессорного модуля.
Была проверена совместимость модели контроллера Ethernet с процессорными модулями трех типов и с IBM-PC-совместимой ЭВМ.
Проверялась совместимость с сетевым оборудованием: коммутаторами и концентраторами разных типов.
Тестовое ПО и ОСРВ Багет могут быть перенесены на разные модули, что дает возможность такой проверки.
Для ОСРВ Багет были использованы тесты чтения и записи файлов, описанные выше.
Проверка совместимости с ОС Linux проводилась на несущем модуле ЦП06.
Выполнялась загрузка ОС Linux с драйвером Ethernet 1Гбит/с.
Использовались стандартные команды работы с сетью: ifconfig, ping, ssh, scp.
Вторым этапом проверки совместимости с ОС Linux стала установка прототипа контроллера Ethernet в IBM-PC-совместимую ЭВМ.
Так как исследуемый прототип выполнен в виде PMCсовместимого модуля, для его установки в разъем PCI материнской платы использовался переходник.
Была проведена адаптация драйвера для работы в версии ядра .
ОС Linux предоставляет большой выбор команд, протоколов работы с сетью и готовых тестов.
Их выполнение позволило проверить прототип сетевого контроллера.
Изменения в программировании СБИС могут повлечь дополнительные затраты сторонних организаций-заказчиков.
Эти затраты связаны с необходимостью изменения ПО и, возможно, c его переаттестацией.
Поэтому при модернизации микросхем или выпуске новых версий проверяется программная совместимость с предыдущими изделиями.
Встраивание сетевого контроллера в микропроцессор неизбежно приведет к изменению программной модели.
Контрольно-статусные регистры будут перенесены из адресного пространства шины PCI на шину физического адреса процессора.
При этом частичная программная совместимость с 1890VG15T упростит и ускорит доработку имеющихся драйверов.
Все эти элементы могут вносить задержки.
Поэтому скорость работы на реальной задаче будет ниже 1 Гбит/с.
Максимальная производительность шины PCI 33 МГц составляет 132 Мбайт/с, которые разделяются между всеми устройствами на шине.
Пропускная способность канала 1000Base-T равна 125 Мбайт/с.
Таким образом, гигабитный Ethernet создает высокую нагрузку на системную шину.
Параллельная работа нескольких требовательных к ресурсам устройств затормозит сетевой контроллер.
Исследуемый прототип использует шину PCI, загрузка которой влияет на производительность.
Другой фактор, оказывающий влияние на производительность, загрузка центрального процессора.
Известно эмпирическое правило: при работе с протоколом TCP требуется 1 ГГц частоты процессора для скорости 1 Гбит/с [4].
В режиме 1 Гбит/с через сетевой контроллер за 1 секунду может пройти до 1 488 000 пакетов длиной 64 байта или 81 000 пакетов по 1 518 байт.
Если прерывание выставляется для каждого пакета, будет создана значительная нагрузка на процессор.
Известны ситуации receive livelock, когда из-за частых прерываний практически останавливаются прикладные программы с более низким по сравнению с драйвером приоритетом.
Система может перестать выполнять свои полезные функции.
Операции сохранения и восстановления контекста трудно поддаются оптимизации, поэтому необходимо введение аппаратного механизма уменьшения количества прерываний [5].
С другой стороны, современные ОС имеют программные механизмы опроса сетевой карты, такие как NAPI или POLLING [6].
Интересна количественная оценка эффективности программных и аппаратных механизмов управления прерываниями.
При тестировании сетевых карт иностранного производства [7] было определено, что наибольшая пропускная способность  достигается для больших пакетов размером 16 Кбайт и выше.
На практике часто используется максимальный размер блока данных  1 500 байт.
В сети обычно возникает бимодальное распределение длин пакетов, большинство пакетов близко или к наименьшей 64 байта, или к наибольшей длине [8].
Оценка загрузки процессора при работе прототипа контроллера Ethernet проводилась в составе IBM-PC-совместимой ЭВМ под управлением ОС Linux и с использованием теста netperf/netserver.
Пример зависимости загрузки процессора от сетевой активности приведен на рисунке 2.
Использование ОС Linux и свободно распространяемого теста позволило сравнить быстродействие прототипа контроллера Ethernet и создаваемую им нагрузку на процессор с иностранным аналогом сетевой картой на основе микросхемы Marvell 88E8003.
Хотя максимальная скорость контроллера Ethernet достигается в составе IBM-PC-совместимой ЭВМ, интересно оценить пропускную способность сетевого контроллера в составе процессорных модулей с меньшим быстродействием.
В качестве тестов использовались задачи на основе механизма сокетов и протокола TCP.
Такие задачи имеют простой исходный код и могут быть скомпилированы как под ОСРВ Багет, так и под ОС Linux.
Скорость работы была измерена для различных модулей серии Багет, а также IBMPC-совместимой ЭВМ.
По результатам составлена таблица, позволяющая оценивать эффективность процессорных модулей путем сравнения их технических характеристик и сетевой производительности.
Задача решается путем выполнения контрольного примера передачи большого объема данных.
Для проверки стабильности и надежности модели контроллера Ethernet были задействованы две инструментальные IBM-PC-совместимые ЭВМ.
Передача данных выполнялась по протоколам NFS и FTP.
Всего запускались четыре потока  передачи данных.
Тест построен по принципу чтения и копирования всех файлов из заданных директорий на инструментальных ЭВМ.
Объем передаваемых на запись данных 11,4 Гбайт.
Столько же информации передавалось на чтение.
Параллельно выполнялась утилита ping с увеличенной до 512 байт длиной пакетов данных.
Запускались два потока в направлении инструментальных ЭВМ.
Для моделирования загруженности несущего модуля ЦП11 запускались тесты других устройств: графического контроллера, контроллера Ethernet 100 Мбит/с и др.
При этом возможна потеря данных, но не должны возникать ситуации, когда перегрузка устройства приводит к сбою или отказу системной шины или к перезагрузке ОС.
Проверялись следующие стрессовые ситуации: переполнение списка дескрипторов при высокой скорости передачи данных, работа в условиях высокой загрузки системы с ограниченной производительностью процессора, а также переполнение счетчика коллизий.
Во время инициализации контроллера драйвер создает два списка дескрипторов, содержащих указатели на буфера принимаемых и передаваемых данных, а также контрольно-статусную информацию.
При получении пакета сетевой контроллер обращается к очередному свободному дескриптору, закрывает его, а принятые данные помещаются в буфер через DMA.
Получив прерывание, драйвер должен передать данные ОС, а затем открыть один или несколько дескрипторов.
Если система перегружена и не успевает вовремя принимать данные, вскоре не остается ни одного открытого дескриптора.
Сетевой контроллер будет вынужден отбрасывать входящие пакеты.
После уменьшения нагрузки должна восстановиться нормальная работа.
Первый тест заключался в работе с максимально высокой скоростью и потерей данных.
Прототип контроллера Ethernet устанавливался в IBMPC-совместимую ЭВМ, обеспечившую максимальное быстродействие со стороны процессора.
Прием и передача данных выполнялись по протоколу UDP одновременно на технологической и инструментальной ЭВМ, чем обеспечивалась загрузка приемника и передатчика прототипа сетевой карты.
В отличие от протокола TCP в UDP отсутствует гарантия доставки датаграмм.
Следовательно, отсутствуют задержки, связанные с таймаутами и необходимостью повторных передач данных.
Поэтому по протоколу UDP обе сетевые карты передают данные с максимальной интенсивностью [9].
Было использовано соединение: 1 Гбит/c, полный дуплекс.
Во время выполнения теста происходила потеря данных из-за превышения пределов нормального функционирования системы.
Для анализа статистики входящего и исходящего трафиков использовались команда iptables OC Linux и команды ОСРВ Багет.
После завершения стрессовой нагрузки был выполнен тест, подтвердивший возобновление нормальной работы прототипа контроллера Ethernet.
Второй тест проверял работу сетевого контроллера при высокой загруженности системы и ограниченной производительности процессора.
Использовался модуль ЦП06 под управлением ОС Linux.
Были задействованы две инструментальные IBM-PC-совместимые ЭВМ, имеющие в своем составе по две сетевые карты .
Каждая карта обладала индивидуальным IP-адресом и выполняла отдельное тестовое задание.
Схема подключения приведена на рисунке 3.
Модуль ЦП06 не имеет жесткого диска.
Использованная схема рассчитана на копирование файлов с одной IBM-PC на другую через тестируемый сетевой контроллер.
Параллельно со стороны обеих ЭВМ и модуля ЦП06 запускался ping с увеличенной интенсивностью передачи и длиной пакетов.
Потери утилиты ping составляли от 6 % до 46 %.
При этом все файлы были успешно скопированы, а ОС Linux и сетевой контроллер продолжали функционировать.
Третьей задачей являлась проверка механизма обработки коллизий.
Технология Ethernet использует CSMA/CD множественный доступ к общей передающей среде с обнаружением несущей и контролем коллизий.
Сам способ доступа предполагает возникновение коллизий, снижающих пропускную способность.
Интерес представали коллизии на дальнем конце кабеля: ситуации, когда две сетевые карты одновременно начинают передавать данные, а также коллизии, возникающие из-за перегруженности активного оборудования: сетевого концентратора  или коммутатора .
Целью тестирования было создание ситуации, когда из-за большого количества коллизий контроллер не сможет передавать пакеты в сеть.
В случае экстремальной загрузки сети у контроллера переполнится внутренний счетчик коллизий.
Но даже в такой ситуации не должны возникать отказы.
Так как задача носила тестовый характер, скорость передачи данных и эффективность использования канала не имели решающего значения.
Наибольшее количество коллизий возникнет при самой низкой скорости работы, 10 Мбит/с, полудуплекс.
Для проверки был выбран заведомо устаревший сетевой концентратор.
Схема подключения приведена на рисунке 4.
Всего использовались пять модулей контроллеров Ethernet 1 Гбит/с на ПЛИС Altera, пять технологических модулей ЦП06 и две IBM-PC-совместимые ЭВМ.
Наиболее интересные результаты дали задачи на основе механизма сокетов и протокола TCP, примененные во время тестирования производительности.
Число коллизий достигало 35 % от суммы принятых и переданных пакетов.
Было получено достаточное количество ситуаций переполнений внутреннего счетчика, что позволило убедиться в корректной работе сетевого контроллера.
В заключение отметим, что рассмотренные в статье тесты модели сетевого контроллера относятся к функциональному тестированию.
Обычно в электронике под этим термином понимают проверку на выполнение заданной функциональности и на соответствие изделия требованиям, указанным в документации.
На практике решается больше задач, и статья показывает расширенную область применения программных тестов.
Кроме того, программные тесты используются для проведения приемо-сдаточных испытаний микросхем и модулей на их основе, для подтверждения технических параметров модулей во время температурных исследований, для диагностики неисправностей в условиях производства.
Эксплуатационные тесты используются для проверки работоспособности готовых изделий.
В дополнение к проверке модели контроллера Ethernet на ПЛИС в НИИСИ РАН выполнялось тестирование его RTL-модели.
Такие тесты дают возможность рассчитывать процент покрытия исходного кода  и обеспечивают доступ к внутренним сигналам модели.
Кроме того, проводилось тестирование модели микропроцессора со встроенным контроллером Ethernet с использованием аппаратного ускорителя PalladiumXP фирмы Cadence.
Ускоритель сочетает достаточно высокую скорость работы и возможность доступа к внутренним сигналам модели.
Тесты модели на ПЛИС не обладают возможностью расчета покрытия.
Лишь на основе технической документации можно сказать, какие блоки устройства были задействованы.
Отсутствует гарантия выявления всех ошибок, что, впрочем, актуально и для других видов тестирования.
Недостатками являются сложность драйверов для современных микросхем, необходимость понимания их работы и взаимодействия с ОС.
При использовании ПЛИС требуются затраты на изготовление технологических плат.
Преимущества тестов моделей на ПЛИС в высоком быстродействии.
Интересна возможность проверить взаимодействие прототипа контроллера с другими устройствами ЭВМ обвязкой, убедиться в работоспособности драйверов, оценить характеристики быстродействия и поведение в реальных условиях.
Такие тесты эффективны, удобны для наглядной демонстрации работы устройств на реальных задачах, востребованы разработчиками и заказчиками.
Для снижения трудоемкости целесообразно подобрать минимальный набор тестов, обеспечивающий решение требуемых задач.
Так, например, копирование файлов по протоколам FTP и NFS было использовано для проверки функциональной пригодности, совместимости, а в дополненном виде для проверки стабильности и надежности.
Применение драйвера снижает затраты на разработку тестового ПО и позволяет концентрировать усилия непосредственно на проверке микросхем.
Этот прием не является универсальным, для каждого устройства подбирается индивидуальная методика тестирования.
ОС Linux дает возможность использования большого количества уже готовых тестов и прикладных программ.
К моменту завершения тестирования прототипа встроенного контроллера Ethernet 1 Гбит/с в качестве отдельного узла была подготовлена модель нового микропроцессора на ПЛИС.
Планируется серийное производство нового процессора в виде микросхемы.
Подготовленные методика и тестовое ПО будут использованы для дальнейших проверок встроенного контроллера Ethernet.
